<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>è§‚å¯Ÿè€…æ¨¡å¼ Demo</title>
  </head>
  <body>
    <div class="container">
      <h1>è§‚å¯Ÿè€…æ¨¡å¼ Demoï¼ˆç›®æ ‡-è§‚å¯Ÿè€…ç›´æ¥å…³è”ï¼‰</h1>
    </div>

    <script>
      // 1. è§‚å¯Ÿè€…æ¨¡å¼æ ¸å¿ƒå®ç°ï¼šç›®æ ‡ç±»ï¼ˆSubjectï¼‰+ è§‚å¯Ÿè€…ç±»ï¼ˆObserverï¼‰
      /**
       * ç›®æ ‡ç±»ï¼ˆSubjectï¼‰- è¢«è§‚å¯Ÿçš„å¯¹è±¡
       * èŒè´£ï¼šç»´æŠ¤è§‚å¯Ÿè€…åˆ—è¡¨ã€æ·»åŠ /ç§»é™¤è§‚å¯Ÿè€…ã€é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…
       */
      class Subject {
        constructor() {
          this.observers = [];
          this.state = null;
        }

        addObserver(observer) {
          // é¿å…é‡å¤æ·»åŠ åŒä¸€ä¸ªè§‚å¯Ÿè€…
          if (!this.observers.includes(observer)) {
            this.observers.push(observer);
          }
        }

        removeObserver(observer) {
          this.observers = this.observers.filter((obs) => obs !== observer);
        }

        /**
         * è®¾ç½®ç›®æ ‡çŠ¶æ€ï¼ˆçŠ¶æ€å˜åŒ–æ—¶è‡ªåŠ¨é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…ï¼‰
         */
        setState(newState) {
          this.state = newState; // æ›´æ–°çŠ¶æ€
          this.notifyObservers(); // é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…
        }

        /**
         * é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…ï¼ˆæ ¸å¿ƒæ–¹æ³•ï¼‰
         * ä¸»åŠ¨è°ƒç”¨æ¯ä¸ªè§‚å¯Ÿè€…çš„ update æ–¹æ³•ï¼Œä¼ é€’å½“å‰çŠ¶æ€
         */
        notifyObservers() {
          this.observers.forEach((observer) => {
            observer.update(this.state); // è§‚å¯Ÿè€…å¿…é¡»å®ç° update æ–¹æ³•
          });
        }
      }

      /**
       * è§‚å¯Ÿè€…ç±»ï¼ˆObserverï¼‰- ç›‘å¬ç›®æ ‡çŠ¶æ€å˜åŒ–
       * èŒè´£ï¼šå®ç° update æ–¹æ³•ï¼Œæ¥æ”¶ç›®æ ‡çš„çŠ¶æ€é€šçŸ¥å¹¶å¤„ç†
       */
      class Observer {
        /**
         * æ„é€ å™¨
         * @param {string} id - è§‚å¯Ÿè€…å”¯ä¸€æ ‡è¯†ï¼ˆç”¨äºå±•ç¤ºï¼‰
         * @param {Function} callback - çŠ¶æ€å˜åŒ–æ—¶çš„å¤„ç†é€»è¾‘
         */
        constructor(id, callback) {
          this.id = id; // è§‚å¯Ÿè€…ID
          this.callback = callback; // è‡ªå®šä¹‰å¤„ç†é€»è¾‘
        }

        /**
         * æ¥æ”¶ç›®æ ‡é€šçŸ¥çš„æ ¸å¿ƒæ–¹æ³•ï¼ˆå¿…é¡»å®ç°ï¼‰
         * @param {any} state - ç›®æ ‡çš„å½“å‰çŠ¶æ€
         */
        update(state) {
          // è°ƒç”¨è‡ªå®šä¹‰å›è°ƒï¼Œä¼ é€’è§‚å¯Ÿè€…IDå’Œç›®æ ‡çŠ¶æ€
          this.callback(this.id, state);
        }
      }

      // 2. Demo ä¸šåŠ¡é€»è¾‘ï¼ˆæ¨¡æ‹Ÿã€Œå•†å“åº“å­˜ã€ç›®æ ‡ï¼Œè§‚å¯Ÿè€…ç›‘å¬åº“å­˜å˜åŒ–ï¼‰

      // åˆå§‹åŒ–ç›®æ ‡ï¼ˆä»¥ã€Œå•†å“åº“å­˜ã€ä¸ºè§‚å¯Ÿç›®æ ‡ï¼‰
      const productSubject = new Subject();
      productSubject.setState(100); // åˆå§‹åº“å­˜ï¼š100

      // DOM å…ƒç´ è·å–
      const logContainer = document.getElementById("logContainer");
      const observerTags = document.getElementById("observerTags");
      const subjectStatus = document.getElementById("subjectStatus");
      let observerId = 1; // è§‚å¯Ÿè€…IDè‡ªå¢å™¨
      const observerInstances = []; // å­˜å‚¨è§‚å¯Ÿè€…å®ä¾‹ï¼ˆç”¨äºç§»é™¤ï¼‰

      // è¾…åŠ©å‡½æ•°ï¼šæ·»åŠ æ—¥å¿—åˆ°é¡µé¢
      function addLog(content, type = "info") {
        const now = new Date().toLocaleTimeString();
        const logItem = document.createElement("div");
        logItem.className = `log-item ${type}`;
        logItem.innerHTML = `
                <div class="log-time">${now}</div>
                <div class="log-content">${content}</div>
            `;
        logContainer.prepend(logItem); // æ–°æ—¥å¿—æ·»åŠ åˆ°é¡¶éƒ¨
      }

      // è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°è§‚å¯Ÿè€…åˆ—è¡¨å±•ç¤º
      function updateObserverTags() {
        if (observerInstances.length === 0) {
          observerTags.innerHTML = '<span class="observer-tag">æš‚æ— è§‚å¯Ÿè€…</span>';
          return;
        }
        observerTags.innerHTML = observerInstances
          .map((obs) => `<span class="observer-tag">è§‚å¯Ÿè€…${obs.id}</span>`)
          .join("");
      }

      // è¾…åŠ©å‡½æ•°ï¼šæ›´æ–°ç›®æ ‡çŠ¶æ€å±•ç¤º
      function updateSubjectStatus() {
        subjectStatus.textContent = `åº“å­˜ï¼š${productSubject.state} ä»¶`;
        addLog(`ğŸ¯ ç›®æ ‡çŠ¶æ€æ›´æ–°ï¼šå•†å“åº“å­˜ = ${productSubject.state} ä»¶`, "success");
      }

      // 1. æ·»åŠ è§‚å¯Ÿè€…æŒ‰é’®äº‹ä»¶
      document.getElementById("addObserverBtn").addEventListener("click", () => {
        const id = `#${observerId++}`;
        // åˆ›å»ºè§‚å¯Ÿè€…å®ä¾‹ï¼ˆè‡ªå®šä¹‰çŠ¶æ€å˜åŒ–çš„å¤„ç†é€»è¾‘ï¼‰
        const observer = new Observer(id, (obsId, state) => {
          addLog(`ğŸ‘ï¸  è§‚å¯Ÿè€…${obsId} æ”¶åˆ°é€šçŸ¥ï¼šå•†å“åº“å­˜æ›´æ–°ä¸º ${state} ä»¶`, "info");
        });
        // ç›®æ ‡æ·»åŠ è¯¥è§‚å¯Ÿè€…
        productSubject.addObserver(observer);
        // å­˜å‚¨è§‚å¯Ÿè€…å®ä¾‹ï¼ˆç”¨äºåç»­ç§»é™¤ï¼‰
        observerInstances.push(observer);
        // æ›´æ–°UI
        updateObserverTags();
        addLog(`â• å·²æ·»åŠ è§‚å¯Ÿè€…${id}ï¼ˆå¯æ¥æ”¶åº“å­˜å˜åŒ–é€šçŸ¥ï¼‰`, "success");
      });

      // 2. ç§»é™¤æœ€åä¸€ä¸ªè§‚å¯Ÿè€…æŒ‰é’®äº‹ä»¶
      document.getElementById("removeObserverBtn").addEventListener("click", () => {
        if (observerInstances.length === 0) {
          addLog(`âŒ æ— è§‚å¯Ÿè€…å¯ç§»é™¤`, "warning");
          return;
        }
        // ç§»é™¤æœ€åä¸€ä¸ªè§‚å¯Ÿè€…å®ä¾‹
        const removedObserver = observerInstances.pop();
        // ç›®æ ‡ç§»é™¤è¯¥è§‚å¯Ÿè€…
        productSubject.removeObserver(removedObserver);
        // æ›´æ–°UI
        updateObserverTags();
        addLog(`â– å·²ç§»é™¤è§‚å¯Ÿè€…${removedObserver.id}ï¼ˆä¸å†æ¥æ”¶é€šçŸ¥ï¼‰`, "warning");
      });

      // 3. æ›´æ–°ç›®æ ‡çŠ¶æ€ï¼ˆè§¦å‘é€šçŸ¥ï¼‰æŒ‰é’®äº‹ä»¶
      document.getElementById("notifyBtn").addEventListener("click", () => {
        // æ¨¡æ‹Ÿåº“å­˜å˜åŒ–ï¼ˆéšæœºå¢å‡ 10-50 ä»¶ï¼‰
        const change = Math.floor(Math.random() * 41) - 20; // -20 åˆ° +20 ä¹‹é—´
        const newState = Math.max(0, productSubject.state + change); // åº“å­˜ä¸ä½äº0
        productSubject.setState(newState); // æ›´æ–°çŠ¶æ€ï¼Œè‡ªåŠ¨é€šçŸ¥è§‚å¯Ÿè€…
        updateSubjectStatus(); // æ›´æ–°UIå±•ç¤º
      });

      // 4. æ¸…ç©ºæ—¥å¿—æŒ‰é’®äº‹ä»¶
      document.getElementById("clearLogBtn").addEventListener("click", () => {
        logContainer.innerHTML = "";
        addLog(`ğŸ—‘ï¸  æ—¥å¿—å·²æ¸…ç©º`, "info");
      });

      // åˆå§‹åŒ–é¡µé¢çŠ¶æ€
      updateObserverTags();
      updateSubjectStatus();
      addLog(`ğŸ“Œ åˆå§‹åŒ–å®Œæˆï¼šç›®æ ‡ï¼ˆå•†å“åº“å­˜ï¼‰åˆå§‹çŠ¶æ€ = 100 ä»¶`, "info");
    </script>
  </body>
</html>
